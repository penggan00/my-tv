name: build-debug-apk

on:
  push:
    tags:
      - 'v*'
  # 可选：添加手动触发，方便测试
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      # 构建调试版APK，自动带调试签名，可直接安装
      - name: Build debug APK with Gradle
        run: ./gradlew assembleDebug -PIS_SO_BUILD=false

      # 生成Release说明（若不需要可删除此步骤和下方body_path配置）
      - name: Generate release notes
        if: success()
        run: |
          if [ -f "history.sh" ]; then
            chmod +x history.sh
            ./history.sh > history.md
          else
            echo "Debug APK Build - $(date +%Y-%m-%d)" > history.md
          fi

      # 创建Release并上传APK（新版Action一步完成）
      - name: Create Release & Upload APK
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref_name }}
          name: Debug Release ${{ github.ref_name }}
          draft: false
          prerelease: false
          body_path: history.md
          # 调试版APK的默认路径
          files: app/build/outputs/apk/debug/app-debug.apk
